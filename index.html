<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OCS Tracker Notes</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: auto;
      padding: 20px;
    }

    label {
      font-weight: bold;
      margin-top: 15px;
      display: block;
    }

    input, select, textarea {
      width: 100%;
      padding: 6px;
      margin-top: 5px;
      font-size: 14px;
    }

    textarea {
      min-height: 90px;
    }

    .radio-group label {
      font-weight: normal;
      margin-right: 15px;
    }

    .config-row {
      display: grid;
      grid-template-columns: 1.2fr 1fr auto;
      gap: 10px;
      margin-top: 10px;
      align-items: center;
    }

    button {
      margin-top: 15px;
      padding: 8px 14px;
      cursor: pointer;
    }

    .remove-btn {
      background: #eee;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>

<h2>OCS Tracker Integration Notes</h2>

<label>OCS Tracker Integration</label>
<select id="integrationType">
  <option>OCS Integration</option>
  <option>OpenDental API Integration</option>
  <option>Denticon Integration</option>
  <option>NexHealth Integration</option>
  <option>Sikka Integration</option>
</select>

<label>Contact Name</label>
<input id="contactName" />

<label>Phone Number</label>
<input id="phoneNumber" />

<label>Integration Status</label>
<select id="integrationStatus">
  <option>Pending</option>
  <option>Active</option>
  <option>Stalled</option>
</select>

<label>Server Access</label>
<div class="radio-group">
  <label><input type="radio" name="serverAccess" value="Yes"> Yes</label>
  <label><input type="radio" name="serverAccess" value="No"> No</label>
</div>

<label>Calendar Sync Configured</label>
<div class="radio-group">
  <label><input type="radio" name="calendarSync" value="Yes"> Yes</label>
  <label><input type="radio" name="calendarSync" value="No"> No</label>
</div>

<label>Configs / Operatory Setup</label>
<div id="configsContainer"></div>
<button onclick="addConfig()">+ Add Operatory</button>

<label>Blocker</label>
<textarea id="blocker"></textarea>

<label>Setup Summary</label>
<textarea id="setupSummary" placeholder="- Calendar sync completed"></textarea>

<button id="gptFixBtn">Fix Grammar & Bullet Points</button>
<button id="copyBtn">Copy Full Note</button>

<script>
const BACKEND_URL = "https://notes-backend-yheh.onrender.com";

/* ---------- Duration Options ---------- */
function createDurationDropdown(selected = "") {
  let options = `<option value="">Select duration</option>`;
  for (let i = 5; i <= 120; i += 5) {
    const label = `${i} mins`;
    options += `<option ${selected === label ? "selected" : ""}>${label}</option>`;
  }
  return `<select>${options}</select>`;
}

/* ---------- Dynamic Operatory Rows ---------- */
function addConfig() {
  const row = document.createElement("div");
  row.className = "config-row";

  row.innerHTML = `
    <input placeholder="Column / Operatory">
    ${createDurationDropdown()}
    <button class="remove-btn" onclick="this.parentElement.remove()">âœ•</button>
  `;

  document.getElementById("configsContainer").appendChild(row);
}

// Add one default row
addConfig();

/* ---------- Auto Bullet Setup Summary ---------- */
const setupSummary = document.getElementById("setupSummary");

setupSummary.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    setupSummary.value += "\n- ";
  }
});

setupSummary.addEventListener("blur", () => {
  const lines = setupSummary.value
    .split("\n")
    .map(l => l.trim())
    .filter(Boolean)
    .map(l => l.startsWith("-") ? l : `- ${l}`);

  setupSummary.value = lines.join("\n");
});

/* ---------- GPT Fix ---------- */
document.getElementById("gptFixBtn").onclick = async () => {
  const text = setupSummary.value;
  if (!text) return alert("Please enter a setup summary.");

  try {
    const res = await fetch(`${BACKEND_URL}/summary`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text })
    });

    if (!res.ok) throw new Error("Backend error");

    const data = await res.json();
    setupSummary.value = data.cleaned;
  } catch (err) {
    console.error(err);
    alert("Failed to connect to backend.");
  }
};

/* ---------- Copy Full Note ---------- */
document.getElementById("copyBtn").onclick = async () => {
  const serverAccess =
    document.querySelector('input[name="serverAccess"]:checked')?.value || "Not set";
  const calendarSync =
    document.querySelector('input[name="calendarSync"]:checked')?.value || "Not set";

  const configs = [...document.querySelectorAll(".config-row")]
    .map(row => {
      const [op, dur] = row.querySelectorAll("input, select");
      return `- ${op.value} | ${dur.value}`;
    }).join("\n");

  const note = `
OCS Tracker Integration: ${integrationType.value}
Contact Name: ${contactName.value}
Phone Number: ${phoneNumber.value}
Integration Status: ${integrationStatus.value}

Server Access: ${serverAccess}
Calendar Sync Configured: ${calendarSync}

Configs / Operatory Setup:
${configs}

Blocker:
${blocker.value}

Setup Summary:
${setupSummary.value}
`;

  await navigator.clipboard.writeText(note.trim());
  alert("Full note copied!");
};
</script>

</body>
</html>
